"use strict";require("core-js/modules/es.symbol"),require("core-js/modules/es.symbol.description"),require("core-js/modules/es.symbol.iterator"),require("core-js/modules/es.array.concat"),require("core-js/modules/es.array.filter"),require("core-js/modules/es.array.find-index"),require("core-js/modules/es.array.from"),require("core-js/modules/es.array.includes"),require("core-js/modules/es.array.iterator"),require("core-js/modules/es.array.map"),require("core-js/modules/es.array.reduce"),require("core-js/modules/es.array.slice"),require("core-js/modules/es.array.some"),require("core-js/modules/es.array.splice"),require("core-js/modules/es.function.name"),require("core-js/modules/es.object.to-string"),require("core-js/modules/es.regexp.to-string"),require("core-js/modules/es.string.includes"),require("core-js/modules/es.string.iterator"),require("core-js/modules/web.dom-collections.iterator"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.processMergeIdentifiers=exports.processMergeIdentifer=exports.mergeReferences=exports.mergeReferenceObject=exports.mergeReferenceArrays=exports.mergeNonReferences=void 0;var _arrays=require("../arrays"),_functions=require("../functions"),_objects=require("../objects"),_cloneHelpers=require("./cloneHelpers");function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,r):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var n=0,t=new Array(r);n<r;n++)t[n]=e[n];return t}var hasUnmergedReferences=function(e){return e.some((function(e){return!1===e.merged}))},mergeNonReferences=function(e,r,n,t){var o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],c=(0,_cloneHelpers.findReferenceIndex)(e,r),s=(0,_cloneHelpers.findReferenceIndex)(n,t);if(c<0)return n[s].complete=!0,n[s].merged=!0,(0,_objects.mapObject)(n[s].object,(function(e){return e}));if(s<0)return e[c].complete=!0,e[c].merged=!0,e[c].object;if(e[c].merged&&n[s].merged)return e[c].object;if(e[c].complete=!0,e[c].merged=!0,n[s].complete=!0,n[s].merged=!0,Array.isArray(e[c].object)&&Array.isArray(n[s].object))return(0,_arrays.mergeArrays)(e[c].object,n[s].object);var a=(0,_arrays.compareArrays)((0,_objects.objectKeys)(e[c].object),(0,_objects.objectKeys)(n[s].object));return e[c].object=a.reduce((function(t,a){var i=e[c].references.findIndex((function(e){return e===a.value}));if(1===a.result[0]){if(i>=0){var u=(0,_cloneHelpers.findReferenceIndex)(e,e[c].object[a.value]);!1===e[u].merged&&(e[u].complete=!0,e[u].merged=!0)}return(0,_objects.setValue)(a.value,e[c].object[a.value],t)}var f=n[s].references.findIndex((function(e){return e===a.value})),l=n[s].object[a.value];if(f>=0&&i<0){var d=(0,_cloneHelpers.findReference)(n,n[s].object[a.value]);l=e[e.length-1].index+1;var m=(0,_cloneHelpers.createReferenceIdentifier)(d.original,l,[r]);m.complete=!1,m.merged=!1,m.object=Array.isArray(d.original)?[]:{},e.push(m),e[c].references.push(a.value),e[c].object[a.value]=l}if(-1===a.result[0])return(0,_objects.setValue)(a.value,l,t);if(i<0)return f<0?(0,_objects.setValue)(a.value,n[s].object[a.value],t):(0,_objects.setValue)(a.value,e[c].object[a.value],t);if(f>=0)return(0,_objects.setValue)(a.value,e[c].object[a.value],t);var p=(0,_cloneHelpers.findReference)(e,e[c].object[a.value]),y=p.referers.findIndex((function(e){return e===r}));return y>=0&&p.referers.splice(y,1),o.push(p),e[c].references.splice(i,1),(0,_objects.setValue)(a.value,n[s].object[a.value],t)}),{}),e[c].object};exports.mergeNonReferences=mergeNonReferences;var mergeReferenceArrays=function e(r,n){if(!Array.isArray(n))return r.findIndex((function(e){return Array.isArray(e)?e[0]===n:e===n}))<0&&r.push(n),r;var t=r.findIndex((function(e){return Array.isArray(e)?e[0]===n[0]:e===n[0]}));if(Array.isArray(n[1])&&(n[1]=n[1].reduce(e,[])),t<0)return[].concat(_toConsumableArray(r),[n]);if(!Array.isArray(r[t]))return(0,_objects.setValue)(t,n,r);if(1===r[t].length)return(0,_objects.setValue)(t,n,r);var o=r[t][1];return Array.isArray(o)?(Array.isArray(n[1])&&(o=(0,_arrays.mergeArrays)(o,n[1])),!Array.isArray(n[1])&&Array.isArray(o)&&o.push(n[1]),(0,_objects.setValue)(t,[n[0],o.reduce(e,[])],r)):(0,_objects.setValue)(t,[n[0],o],r)};exports.mergeReferenceArrays=mergeReferenceArrays;var mergeReferenceObject=function e(r,n,t){return function(o,c,s){var a=!1,i=c;if(Array.isArray(c)&&null===(i=Array.isArray(c[0])?c[0]:c)[1]&&(c=i[0],a=!0),Array.isArray(c)){var u=o.object[i[0]],f=t.object[i[0]];"number"==typeof u&&(o.index=u,u=(0,_cloneHelpers.findReference)(r,u).object),"number"==typeof f&&(t.index=f,f=(0,_cloneHelpers.findReference)(n,f).object);var l=i[1].map((function(e){return e})),d=i[1],m=i[1].map((function(e){return e})),p=(0,_cloneHelpers.objectAndReferences)(u,d,o.index),y=(0,_cloneHelpers.objectAndReferences)(f,m,t.index),b=function(t){var o=l[t],s=i[1].findIndex((function(e){return e===o}));e(r,n,y)(p,o,s),c[1]=p.references};for(var j in l)b(j);return o.remove=[].concat(_toConsumableArray(o.remove),_toConsumableArray(p.remove)),o}var v=o.object[c],g=t.object[c];if("number"!=typeof g){if("number"==typeof v){var A=(0,_cloneHelpers.findReferenceIndex)(r,v);r[A].complete=!0,r[A].merged=!0}return o}var _=(0,_cloneHelpers.findReference)(n,g);if(void 0===_.merged)return o;var R=(0,_cloneHelpers.findReference)(r,v);if(_.complete=!0,_.merged=!0,void 0===R.merged)return o;o.object[c]=mergeNonReferences(r,R.index,n,_.index,o.remove);var x=R.referers.findIndex((function(e){return e===o.index}));R.referers.splice(x,1);var I=R.references.map((function(e){return R.circular.includes(e)?[e,null]:e}));o.remove.push(R);var h=(0,_cloneHelpers.findReferenceIndex)(r,v);return r[h]=R,I.length&&!a?(o.references[s]=[c,I],o.references=o.references.reduce(mergeReferenceArrays,[]),o):(o.references.splice(s,1),o)}};exports.mergeReferenceObject=mergeReferenceObject;var mergeReferences=function e(r,n){if(void 0===r[0].merged||void 0===n[0].merged)return r;var t=[];r[0].object=mergeNonReferences(r,0,n,0,t);var o=(0,_arrays.mergeArrays)(r[0].references,n[0].references);o=o.reduce(mergeReferenceArrays,[]);var c=(0,_cloneHelpers.objectAndReferences)(r[0].object,o,0),s=(0,_cloneHelpers.objectAndReferences)(n[0].object,n[0].references,0),a=o.map((function(e){return e})),i=function(e){var t=a[e],o=r[0].references.findIndex((function(e){return e===t}));mergeReferenceObject(r,n,s)(c,t,o),r[0].references=c.references};for(var u in a)i(u);t=[].concat(_toConsumableArray(t),_toConsumableArray(c.remove));var f=(0,_cloneHelpers.removeFromReferenceMap)(r),l=t.reduce((function(e,r){var n=f(r);return e?n:e}),!0);return l&&(r=(0,_cloneHelpers.linkReferences)(r)),l&&(1===r.length&&n.map((function(e){return e.complete=!0,e.merged=!0,e})),n=(0,_cloneHelpers.linkReferences)(n)),hasUnmergedReferences(r)&&hasUnmergedReferences(n)?e(r,n):r};exports.mergeReferences=mergeReferences;var processMergeIdentifer=function(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},t=n.mapLimit,o=void 0===t?100:t,c=(n.depthLimit,0);return e=(0,_functions.pipe)((function(r){return(0,_cloneHelpers.findReferenceIndex)(e,r.index)}),(function(r){return c=r,(0,_cloneHelpers.findObjectReferences)(e[c])}),(function(r){return(0,_cloneHelpers.findReferenceKeys)(e,c)}),(function(n){e[c].merged=!1;var t=e[c].references.filter((function(e){return!n.circular.includes(e)}));return r=[].concat(_toConsumableArray(r),_toConsumableArray(t.map((function(r){return e[n.object[r]]})))),e.length>=o}))(r.shift()),r};exports.processMergeIdentifer=processMergeIdentifer;var processMergeIdentifiers=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r.mapLimit,t=void 0===n?100:n,o=r.depthLimit,c=void 0===o?-1:o,s=[(0,_cloneHelpers.createReferenceIdentifier)(e,0)],a=[s[0]];do{a=processMergeIdentifer(s,a,{mapLimit:t,depthLimit:c})}while(a.length>0);return s};exports.processMergeIdentifiers=processMergeIdentifiers;