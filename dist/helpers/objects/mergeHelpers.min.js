"use strict";require("core-js/modules/es.symbol"),require("core-js/modules/es.symbol.description"),require("core-js/modules/es.symbol.iterator"),require("core-js/modules/es.array.concat"),require("core-js/modules/es.array.filter"),require("core-js/modules/es.array.find-index"),require("core-js/modules/es.array.from"),require("core-js/modules/es.array.includes"),require("core-js/modules/es.array.iterator"),require("core-js/modules/es.array.map"),require("core-js/modules/es.array.reduce"),require("core-js/modules/es.array.slice"),require("core-js/modules/es.array.some"),require("core-js/modules/es.array.splice"),require("core-js/modules/es.function.name"),require("core-js/modules/es.object.to-string"),require("core-js/modules/es.regexp.to-string"),require("core-js/modules/es.string.includes"),require("core-js/modules/es.string.iterator"),require("core-js/modules/web.dom-collections.iterator"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.processMergeIdentifiers=exports.processMergeIdentifer=exports.mergeReferences=exports.mergeReferenceObject=exports.mergeReferenceArrays=exports.mergeNonReferences=exports.hasUnmergedReferences=void 0;var _arrays=require("../arrays"),_functions=require("../functions"),_objects=require("../objects"),_cloneHelpers=require("./cloneHelpers");function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,r):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var n=0,o=new Array(r);n<r;n++)o[n]=e[n];return o}var hasUnmergedReferences=function(e){return e.some((function(e){return!1===e.merged}))};exports.hasUnmergedReferences=hasUnmergedReferences;var mergeNonReferences=function(e,r,n,o){var t=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],c=(0,_cloneHelpers.findReferenceIndex)(e,r),s=(0,_cloneHelpers.findReferenceIndex)(n,o);if(c<0)return n[s].complete=!0,n[s].merged=!0,(0,_objects.mapObject)(n[s].object,(function(e){return e}));if(s<0)return e[c].complete=!0,e[c].merged=!0,e[c].object;if(e[c].merged&&n[s].merged)return e[c].object;if(e[c].complete=!0,e[c].merged=!0,n[s].complete=!0,n[s].merged=!0,Array.isArray(e[c].object)&&Array.isArray(n[s].object))return(0,_arrays.mergeArrays)(e[c].object,n[s].object);var i=(0,_arrays.mergeArrays)((0,_objects.objectKeys)(e[c].object),(0,_objects.objectKeys)(n[s].object));return e[c].object=i.reduce((function(o,i){if(n[s].references.includes(i)){var a=e[c].object[i];if("number"!=typeof a){var u=(0,_cloneHelpers.findReferenceIndex)(n,n[s].object[i]);!1===n[u].merged&&(n[u].complete=!0,n[u].merged=!0),a=e[e.length-1].index+1;var f=(0,_cloneHelpers.findReference)(n,n[s].object[i]),l=(0,_cloneHelpers.createReferenceIdentifier)(f.original,a,[c]);return l.circular=f.circular,l.complete=f.complete,l.merged=f.merged,l.object=(0,_objects.mapObject)(f.object,(function(e){return e})),l.references=f.references.map((function(e){return e})),e.push(l),e[c].references.push(i),(0,_objects.setValue)(i,a,o)}return(0,_objects.setValue)(i,a,o)}var d=e[c].references.findIndex((function(e){return e===i}));if(d>=0){var m=(0,_cloneHelpers.findReferenceIndex)(e,e[c].object[i]);!1===e[m].merged&&(e[m].complete=!0,e[m].merged=!0)}if(void 0===n[s].object[i])return(0,_objects.setValue)(i,e[c].object[i],o);if(d>=0){var p=(0,_cloneHelpers.findReference)(e,o[i]),y=p.referers.findIndex((function(e){return e===r}));y>=0&&p.referers.splice(y,1),t.push(p),e[c].references.splice(d,1)}return(0,_objects.setValue)(i,n[s].object[i],o)}),{}),e[c].object};exports.mergeNonReferences=mergeNonReferences;var mergeReferenceArrays=function e(r,n){if(!Array.isArray(n))return r.findIndex((function(e){return!!Array.isArray(e)&&e[0]===n}))<0&&r.push(n),r;var o=r.findIndex((function(e){return Array.isArray(e)?e[0]===n[0]:e===n[0]}));if(Array.isArray(n[1])&&(n[1]=n[1].reduce(e,[])),o<0)return r.push(n),r;if(!Array.isArray(r[o]))return r[o]=n,r;var t=r[o][1];return Array.isArray(t)?(Array.isArray(n[1])&&(t=(0,_arrays.mergeArrays)(t,n[1])),!Array.isArray(n[1])&&Array.isArray(t)&&t.push(n[1]),t=t.reduce(e,[]),r[o]=[n[0],t],r):(r[o]=[n[0],t],r)};exports.mergeReferenceArrays=mergeReferenceArrays;var mergeReferenceObject=function e(r,n){return function(o,t,c,s){var i=!1,a=c;if(Array.isArray(c)&&null===(a=Array.isArray(c[0])?c[0]:c)[1]&&(c=a[0],i=!0),Array.isArray(c)){var u=o.object[a[0]],f=t.object[a[0]];"number"==typeof u&&(o.index=u,u=(0,_cloneHelpers.findReference)(r,u).object),"number"==typeof f&&(t.index=f,f=(0,_cloneHelpers.findReference)(n,f).object);var l=a[1].map((function(e){return e})),d=a[1],m=a[1].map((function(e){return e})),p=(0,_cloneHelpers.objectAndReferences)(u,d,o.index),y=(0,_cloneHelpers.objectAndReferences)(f,m,t.index),b=function(o){var t=l[o],s=a[1].findIndex((function(e){return e===t}));p=e(r,n)(p,y,t,s),c[1]=p.references};for(var j in l)b(j);return o.remove=[].concat(_toConsumableArray(o.remove),_toConsumableArray(p.remove)),o}var g=o.object[c],v=t.object[c];if("number"!=typeof v){if("number"==typeof g){var A=(0,_cloneHelpers.findReferenceIndex)(r,g);r[A].complete=!0,r[A].merged=!0}return o}var _=(0,_cloneHelpers.findReference)(n,v);if(void 0===_.merged)return o;var R=(0,_cloneHelpers.findReference)(r,g);if(_.complete=!0,_.merged=!0,"number"!=typeof g&&(g=r[r.length-1].index+1,(R=(0,_cloneHelpers.createReferenceIdentifier)(_.original,g,[o.index])).circular=_.circular,R.complete=_.complete,R.merged=_.merged,R.object=(0,_objects.mapObject)(_.object,(function(e){return e})),R.references=_.references.map((function(e){return e})),r.push(R)),void 0===R.merged)return o;o.object[c]=mergeNonReferences(r,R.index,n,_.index,o.remove);var x=R.referers.findIndex((function(e){return e===o.index}));R.referers.splice(x,1);var h=R.references.map((function(e){return R.circular.includes(e)?[e,null]:e}));o.remove.push(R);var I=(0,_cloneHelpers.findReferenceIndex)(r,g);return r[I]=R,h.length&&!i?(o.references[s]=[c,h],o.references=o.references.reduce(mergeReferenceArrays,[]),o):(o.references.splice(s,1),o)}};exports.mergeReferenceObject=mergeReferenceObject;var mergeReferences=function e(r,n){if(void 0===r[0].merged||void 0===n[0].merged)return r;var o=[];r[0].object=mergeNonReferences(r,0,n,0,o);var t=(0,_arrays.mergeArrays)(r[0].references,n[0].references);t=t.reduce(mergeReferenceArrays,[]);var c=(0,_cloneHelpers.objectAndReferences)(r[0].object,t,0),s=(0,_cloneHelpers.objectAndReferences)(n[0].object,n[0].references,0),i=t.map((function(e){return e})),a=function(e){var o=i[e],t=r[0].references.findIndex((function(e){return e===o}));c=mergeReferenceObject(r,n)(c,s,o,t),r[0].object=c.object,r[0].references=c.references,n[0].object=s.object,n[0].references=s.references};for(var u in i)a(u);o=[].concat(_toConsumableArray(o),_toConsumableArray(c.remove));var f=(0,_cloneHelpers.removeFromReferenceMap)(r),l=o.reduce((function(e,r){var n=f(r);return e?n:e}),!0);return l&&(r=(0,_cloneHelpers.linkReferences)(r)),l&&(1===r.length&&n.map((function(e){return e.complete=!0,e.merged=!0,e})),n=(0,_cloneHelpers.linkReferences)(n)),hasUnmergedReferences(r)&&hasUnmergedReferences(n)?e(r,n):r};exports.mergeReferences=mergeReferences;var processMergeIdentifer=function(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=n.mapLimit,t=void 0===o?100:o,c=(n.depthLimit,0);return e=(0,_functions.pipe)((function(r){return(0,_cloneHelpers.findReferenceIndex)(e,r.index)}),(function(r){return c=r,(0,_cloneHelpers.findObjectReferences)(e[c])}),(function(r){return(0,_cloneHelpers.findReferenceKeys)(e,c)}),(function(n){e[c].merged=!1;var o=e[c].references.filter((function(e){return!n.circular.includes(e)}));return r=[].concat(_toConsumableArray(r),_toConsumableArray(o.map((function(r){return e[n.object[r]]})))),e.length>=t}))(r.shift()),r};exports.processMergeIdentifer=processMergeIdentifer;var processMergeIdentifiers=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r.mapLimit,o=void 0===n?100:n,t=r.depthLimit,c=void 0===t?-1:t,s=[(0,_cloneHelpers.createReferenceIdentifier)(e,0)],i=[s[0]];do{i=processMergeIdentifer(s,i,{mapLimit:o,depthLimit:c})}while(i.length>0);return s};exports.processMergeIdentifiers=processMergeIdentifiers;