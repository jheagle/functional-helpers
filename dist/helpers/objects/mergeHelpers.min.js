"use strict";require("core-js/modules/es.symbol"),require("core-js/modules/es.symbol.description"),require("core-js/modules/es.symbol.iterator"),require("core-js/modules/es.array.concat"),require("core-js/modules/es.array.every"),require("core-js/modules/es.array.filter"),require("core-js/modules/es.array.find"),require("core-js/modules/es.array.find-index"),require("core-js/modules/es.array.from"),require("core-js/modules/es.array.includes"),require("core-js/modules/es.array.iterator"),require("core-js/modules/es.array.map"),require("core-js/modules/es.array.reduce"),require("core-js/modules/es.array.slice"),require("core-js/modules/es.array.some"),require("core-js/modules/es.array.splice"),require("core-js/modules/es.function.name"),require("core-js/modules/es.object.to-string"),require("core-js/modules/es.regexp.to-string"),require("core-js/modules/es.string.includes"),require("core-js/modules/es.string.iterator"),require("core-js/modules/web.dom-collections.iterator"),Object.defineProperty(exports,"__esModule",{value:!0}),exports.processMergeIdentifiers=exports.processMergeIdentifer=exports.mergeReferences=exports.mergeReferenceObject=exports.mergeReferenceArrays=exports.mergeNonReferences=exports.createReferenceReplica=exports.getSimilarObject=void 0;var _arrays=require("../arrays"),_functions=require("../functions"),_objects=require("../objects"),_cloneHelpers=require("./cloneHelpers");function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,r){if(e){if("string"==typeof e)return _arrayLikeToArray(e,r);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,r):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var n=0,t=new Array(r);n<r;n++)t[n]=e[n];return t}var hasUnmergedReferences=function(e){return e.some((function(e){return!1===e.merged}))},getSimilarObject=function(e,r){var n=Array.isArray(r.original),t=(0,_objects.objectKeys)(r.object).filter((function(e){return!r.references.includes(e)&&!(0,_objects.isObject)(r.object[e])})),c=t.map((function(e){return r.object[e]}));if(t.length)return e.find((function(e){if(Array.isArray(e.original)!==n)return!1;var r=(0,_objects.objectKeys)(e.object).filter((function(r){return!e.references.includes(r)&&!(0,_objects.isObject)(e.object[r])})).map((function(r){return e.object[r]}));return(0,_arrays.compareArrays)(r,c).every((function(e){return e.result.every((function(e){return 0===e}))}))}))};exports.getSimilarObject=getSimilarObject;var createReferenceReplica=function e(r,n){return function(t,c){var o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],s=Array.isArray(c.original)?[]:{},i=(0,_cloneHelpers.createReferenceIdentifier)(s,t,o);i.complete=c.complete,i.merged=c.merged,i.object=s,i.circular=c.circular;var a=r.length;return r.push(i),i.object=(0,_objects.objectKeys)(c.object).reduce((function(o,s){if(c.references.includes(s)&&i.references.push(s),!c.circular.includes(s))return(0,_objects.setValue)(s,c.object[s],o);var a=(0,_cloneHelpers.findReference)(n,c.object[s]),u=getSimilarObject(r,a),f=void 0!==u,l=f?u.index:r[r.length-1].index+1;return f||(u=e(r,n)(l,a)),u.referers.push(t),(0,_objects.setValue)(s,l,o)}),i.object),i.object=i.references.reduce((function(o,s){if(c.circular.includes(s))return o;var i=(0,_cloneHelpers.findReference)(n,c.object[s]),a=getSimilarObject(r,i),u=void 0!==a,f=u?a.index:r[r.length-1].index+1;return u||(a=e(r,n)(f,i)),a.referers.push(t),o[s]=f,o}),i.object),r[a]}};exports.createReferenceReplica=createReferenceReplica;var mergeNonReferences=function(e,r,n,t){var c=arguments.length>4&&void 0!==arguments[4]?arguments[4]:[],o=(0,_cloneHelpers.findReferenceIndex)(e,r),s=(0,_cloneHelpers.findReferenceIndex)(n,t);if(o<0)return n[s].complete=!0,n[s].merged=!0,(0,_objects.mapObject)(n[s].object,(function(e){return e}));if(s<0)return e[o].complete=!0,e[o].merged=!0,e[o].object;if(e[o].merged&&n[s].merged)return e[o].object;e[o].complete=!0,e[o].merged=!0,n[s].complete=!0,n[s].merged=!0;var i=Array.isArray(e[o].object),a=i?(0,_arrays.compareArrays)(e[o].object,n[s].object):(0,_arrays.compareArrays)((0,_objects.objectKeys)(e[o].object),(0,_objects.objectKeys)(n[s].object));return e[o].object=a.reduce((function(t,a,u){var f=i?e[o].references.findIndex((function(e){return a.keys[0].includes(e)})):e[o].references.findIndex((function(e){return e===a.value})),l=i?u:a.value,d=i?e[o].object[a.keys[0][0]]:e[o].object[a.value],m=i?n[s].object[a.keys[1][0]]:n[s].object[a.value];if(1===a.result[0]){if(f>=0){var p=(0,_cloneHelpers.findReferenceIndex)(e,d);!1===e[p].merged&&(e[p].complete=!0,e[p].merged=!0)}return(0,_objects.setValue)(l,d,t)}var b=i?n[s].references.findIndex((function(e){return a.keys[1].includes(e)})):n[s].references.findIndex((function(e){return e===a.value})),y=m;if(b>=0&&f<0){var j=(0,_cloneHelpers.findReference)(n,m),g=getSimilarObject(e,j),v=void 0!==g;if(y=v?g.index:e[e.length-1].index+1,v||(g=createReferenceReplica(e,n)(y,j,[r])),i||(e[o].references.push(l),e[o].object[l]=y),i&&!e[o].object.includes(y)&&(e[o].references.push(e[o].object.length),e[o].object.push(y)),v)return t;d=y,j.complete=!0,j.merged=!0}if(-1===a.result[0])return i?(t.push(y),t):(0,_objects.setValue)(l,y,t);if(f<0)return b<0?(0,_objects.setValue)(l,m,t):(0,_objects.setValue)(l,d,t);if(b>=0)return(0,_objects.setValue)(l,d,t);var _=(0,_cloneHelpers.findReference)(e,d),R=_.referers.findIndex((function(e){return e===r}));return R>=0&&_.referers.splice(R,1),c.push(_),e[o].references.splice(f,1),(0,_objects.setValue)(l,m,t)}),i?[]:{}),e[o].object};exports.mergeNonReferences=mergeNonReferences;var mergeReferenceArrays=function e(r,n){if(!Array.isArray(n))return r.findIndex((function(e){return Array.isArray(e)?e[0]===n:e===n}))<0&&r.push(n),r;var t=r.findIndex((function(e){return Array.isArray(e)?e[0]===n[0]:e===n[0]}));if(Array.isArray(n[1])&&(n[1]=n[1].reduce(e,[])),t<0)return[].concat(_toConsumableArray(r),[n]);if(!Array.isArray(r[t]))return(0,_objects.setValue)(t,n,r);if(1===r[t].length)return(0,_objects.setValue)(t,n,r);var c=r[t][1];return Array.isArray(c)?(Array.isArray(n[1])&&(c=(0,_arrays.mergeArrays)(c,n[1])),!Array.isArray(n[1])&&Array.isArray(c)&&c.push(n[1]),(0,_objects.setValue)(t,[n[0],c.reduce(e,[])],r)):(0,_objects.setValue)(t,[n[0],c],r)};exports.mergeReferenceArrays=mergeReferenceArrays;var mergeReferenceObject=function e(r,n,t){return function(c,o,s){var i=!1,a=o;if(Array.isArray(o)&&null===(a=Array.isArray(o[0])?o[0]:o)[1]&&(o=a[0],i=!0),Array.isArray(o)){var u=c.object[a[0]],f=t.object[a[0]];"number"==typeof u&&(c.index=u,u=(0,_cloneHelpers.findReference)(r,u).object),"number"==typeof f&&(t.index=f,f=(0,_cloneHelpers.findReference)(n,f).object);var l=a[1].map((function(e){return e})),d=a[1],m=a[1].map((function(e){return e})),p=(0,_cloneHelpers.objectAndReferences)(u,d,c.index),b=(0,_cloneHelpers.objectAndReferences)(f,m,t.index),y=function(t){var c=l[t],s=a[1].findIndex((function(e){return e===c}));e(r,n,b)(p,c,s),o[1]=p.references};for(var j in l)y(j);return c.remove=[].concat(_toConsumableArray(c.remove),_toConsumableArray(p.remove)),c}var g=c.object[o],v=t.object[o];if("number"!=typeof v){if("number"==typeof g){var _=(0,_cloneHelpers.findReferenceIndex)(r,g);r[_].complete=!0,r[_].merged=!0}return c}var R=(0,_cloneHelpers.findReference)(n,v);if(void 0===R)return c;if(void 0===R.merged)return c;var A="number"==typeof g?(0,_cloneHelpers.findReference)(r,g):null;if("number"!=typeof g){var x=void 0!==(A=getSimilarObject(r,R));g=x?A.index:r[r.length-1].index+1,x||(A=createReferenceReplica(r,n)(g,R,[c.index])),c.references.push(o),c.object[o]=g}if(R.complete=!0,R.merged=!0,void 0===A.merged)return c;c.object[o]=mergeNonReferences(r,A.index,n,R.index,c.remove);var h=A.referers.findIndex((function(e){return e===c.index}));A.referers.splice(h,1);var I=A.references.map((function(e){return A.circular.includes(e)?[e,null]:e}));c.remove.push(A);var H=(0,_cloneHelpers.findReferenceIndex)(r,g);return r[H]=A,I.length&&!i?(c.references[s]=[o,I],c.references=c.references.reduce(mergeReferenceArrays,[]),c):(c.references.splice(s,1),c)}};exports.mergeReferenceObject=mergeReferenceObject;var mergeReferences=function e(r,n){if(void 0===r[0].merged||void 0===n[0].merged)return r;var t=[];r[0].object=mergeNonReferences(r,0,n,0,t);var c=(0,_arrays.mergeArrays)(r[0].references,n[0].references);c=c.reduce(mergeReferenceArrays,[]);var o=(0,_cloneHelpers.objectAndReferences)(r[0].object,c,0),s=(0,_cloneHelpers.objectAndReferences)(n[0].object,n[0].references,0),i=c.map((function(e){return e})),a=function(e){var t=i[e],c=r[0].references.findIndex((function(e){return e===t}));mergeReferenceObject(r,n,s)(o,t,c),r[0].references=o.references};for(var u in i)a(u);t=[].concat(_toConsumableArray(t),_toConsumableArray(o.remove));var f=(0,_cloneHelpers.removeFromReferenceMap)(r),l=t.reduce((function(e,r){var n=f(r);return e?n:e}),!0);return l&&(r=(0,_cloneHelpers.linkReferences)(r)),l&&(1===r.length&&n.map((function(e){return e.complete=!0,e.merged=!0,e})),n=(0,_cloneHelpers.linkReferences)(n)),hasUnmergedReferences(r)||hasUnmergedReferences(n)?e(r,n):r};exports.mergeReferences=mergeReferences;var processMergeIdentifer=function(e){return function(r){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},t=n.mapLimit,c=void 0===t?100:t,o=n.depthLimit,s=void 0===o?-1:o;if(!e[r].moreReferences.length)return e[r].moreReferences;var i=0,a=!1;return e[r].referenceMap=(0,_functions.pipe)((function(n){return(0,_cloneHelpers.findReferenceIndex)(e[r].referenceMap,n.index)}),(function(n){return i=n,(0,_cloneHelpers.findObjectReferences)(e[r].referenceMap[i])}),(function(n){return(0,_cloneHelpers.getIdentifierDepth)(e[r].referenceMap,n)}),(function(e){return e===s}),(function(n){return a=n,(0,_cloneHelpers.findReferenceKeys)(e[r].referenceMap,i,a)}),(function(n){a&&(e[r].referenceMap[i].references=n.circular),e[r].referenceMap[i].merged=!1;var t=e[r].referenceMap[i].references.filter((function(e){return!n.circular.includes(e)}));return e[r].moreReferences=[].concat(_toConsumableArray(e[r].moreReferences),_toConsumableArray(t.map((function(t){return e[r].referenceMap[n.object[t]]})))),e[r].referenceMap.length>=c}),(function(n){return n?mergeReferences(e[0].referenceMap,e[1].referenceMap):e[r].referenceMap}))(e[r].moreReferences.shift()),e[r].moreReferences}};exports.processMergeIdentifer=processMergeIdentifer;var processMergeIdentifiers=function(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},t=n.mapLimit,c=void 0===t?100:t,o=n.depthLimit,s=void 0===o?-1:o,i=[(0,_cloneHelpers.createReferenceIdentifier)(e,0)],a=[(0,_cloneHelpers.createReferenceIdentifier)(r,0)],u=[{referenceMap:i,moreReferences:[i[0]]},{referenceMap:a,moreReferences:[a[0]]}];do{u[0].moreReferences=processMergeIdentifer(u)(0,{mapLimit:c,depthLimit:s}),u[1].moreReferences=processMergeIdentifer(u)(1,{mapLimit:c,depthLimit:s})}while(u[0].moreReferences.length>0||u[1].moreReferences.length>0);return[i,a]};exports.processMergeIdentifiers=processMergeIdentifiers;